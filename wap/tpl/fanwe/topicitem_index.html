{include file="./inc/header_common.html"}

				<div style="padding:10px 0; background:#fff; border-bottom: 1px solid #e6e6e6; ">
					<a href="javascript:void(0);" onclick="window.history.go(-1);"><i class="fa fa-chevron-left"></i>&nbsp;返回</a>
				</div>

				<div class="wrap" id="wrap">
				{if $data.exit eq 1}
					<div class="blank8"></div>					
					<div class="list-view">
						<div style="padding:10px; line-height:20px; font-size:16px; border-bottom: 1px solid #f5f5f5; width:100%;">
							<span>[讨论]&nbsp;{$data.topic_item.forum_title}</span>
						</div>
						<div style="padding:10px;border-bottom: 1px solid #f5f5f5; display: -webkit-box; color:#adadad;">							
							<div style="padding:10px;width:80px;text-align:center; ">
								{if $data.topic_item.user_id eq $data.user_id}
								<a href='{wap_url a="index" r="user_center#index"}'>
								{else}
								<a href='{wap_url a="index" r="userinfo#index" p="user_id=$data.topic_item.user_id"}'>
								{/if}
						 	    <img style="border-radius:35px;" src='{function name="get_user_avatar" uid=$data.topic_item.user_id type="small" }'>
								</a>
							</div>
							<div>
								<span>{$data.topic_item.user_name}</span><br/>
								<span style="padding-left:15px;">{function name="get_user_intro_byid" uid=$data.topic_item.user_id}</span><br/>
								<span>等级：{function name="get_user_level_byid" uid=$data.topic_item.user_id}</span>
							</div>
						</div>
						<div style="padding:10px;color:#adadad;">
							{$data.topic_item.content}
						</div>
						<div style="padding:10px;color:#adadad;text-align:right;">
							<span style="padding-right:5px;">浏览&nbsp;{$data.topic_item.hit_count}</span>
							<span style="cursor:pointer; padding-right:5px;" onclick="favorite_topic({$data.topic_item.id},{$data.topic_item.user_id})">
								{if $data.topic_item.is_fav eq 1}
								<font id="fav_text_{$data.topic_item.id}">已点赞</font>&nbsp;<font id="fav_count_{$data.topic_item.id}">{$data.topic_item.fav_count}</font>
								{else}
								<font id="fav_text_{$data.topic_item.id}">点赞</font>&nbsp;<font id="fav_count_{$data.topic_item.id}">{$data.topic_item.fav_count}</font>
								{/if}
							</span>
							<span style="padding-right:5px;">回复&nbsp;<font id="topic_reply_count">{$data.topic_item.reply_count}</font></span>
							<span style="padding-left:20px;">{function name="pass_date" time=$data.topic_item.create_time }</span>
						</div>
					</div><!--list-view end-->
					
					{if $data.topic_item.reply_count gt 0}
					<div class="blank8"></div> 					
					<div class="list-view">
						 <ul class="">
						 {foreach from=$data.topic_reply_list item=topic_reply key=key}
							<li class="topic_item_reply_li" id="reply_item_{$topic_reply.id}">
						 	     <div class="list_item">
						 	    	 <div class="topic_user_headimg">
										{if $topic_reply.user_id eq $data.user_id}
										<a href='{wap_url a="index" r="user_center#index"}'>
										{else}
										<a href='{wap_url a="index" r="userinfo#index" p="user_id=$topic_reply.user_id"}'>
										{/if}
						 	    	 	<img src='{function name="get_user_avatar" uid=$topic_reply.user_id type="small" }'>
										</a>
						 	     	 </div>
									 <div class="info">										
										<div class="reply_topic_bottom">
						                    <p class="reply_topic_bottom_text">
												<em><i>{$topic_reply.user_name}<i>&nbsp;•&nbsp;</i>{function name="pass_date" time=$topic_reply.create_time }说</i></em>					 
											</p>											
											<p class="reply_topic_bottom_text_right">
												<!--
												#{function name="floor_num" k=$key base_size=$data.base_size }
												-->
												<a href="#topic_reply" onclick="set_reply({$topic_reply.id},'{$topic_reply.user_id}','{$topic_reply.user_name}');"><i>回复</i></a>
												{if $topic_reply.user_id eq $data.user_id}
												<a href="javascript:void(0);" onclick="delete_topic_reply({$topic_reply.id},$('#reply_item_{$topic_reply.id}'));"><i>删除</i></a>
												{/if}
											</p>											
						                </div>
										<div class="reply_topic_bottom_p">
											<p class="content">{function name="nl2br" v=$topic_reply.content}</p>	
										</div>
									</div>
						 	     </div>
						 	</li>
						 {/foreach}
						 </ul>	
						{if $data.page.page_total gt 1}
						<div class="fy">
							{$pages}
						</div>
						{/if}
					</div><!--list-view end-->
					{/if}
					
					<div class="blank8"></div>
					<div id="topic_reply" style="border-top: 1px solid #e6e6e6; border-bottom: 1px solid #e6e6e6;">
					<form id="" name="topic_reply_form" method="post" action='{wap_url a="index" r="topicreply"}' onsubmit="return check(this);">
						<div class="topic_write_txt">
							<input type="hidden" name="topic_id" id="topic_id" value="{$data.topic_item.id}" />
							<input type="hidden" name="reply_id" id="reply_id" value="0" />
							<input type="hidden" name="reply_user_id" id="reply_user_id" value="0" />
							<input type="hidden" name="reply_user_name" id="reply_user_name" value="" />
							<textarea name="content" id="content" placeholder="请输入回复内容"></textarea>
							<div class="blank"></div>					
						</div>
						<div class="btn_login">
							<input type="submit" name="Submit" class="mj-submit" value="回复" style="background: none;">
						</div>
					</form>
					</div>					
			    {/if}
				{if $data.exit eq 0}
					<div style="margin-top:10px;margin-bottom:10px;text-align:center;">
					{$data.msg}
					</div>
				{/if}
				</div><!--wrap end-->	
				
				<!--帖子删除成功后的提示语-->
				<div id="topicdel" style="display:none;margin-top:10px;margin-bottom:10px;text-align:center;">
					<span id="topicdelmsg"></span>
				</div>

<script type="text/javascript">
function favorite_topic(topic_id,author_user_id){
	//alert(topic_id+"--"+author_user_id);
	var text_id = "fav_text_"+topic_id;
	var count_id = "fav_count_"+topic_id;
	var query = new Object();
	query.topic_id = topic_id;
	query.author_user_id = author_user_id;
	query.post_type = "json";
	var ajaxurl = '{wap_url a="index" r="topicfavorite#index"}';

	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.user_login_status==0){
				alert(data.login_info);
			}else{
				if(data.fav_status == 1){
					alert("取消点赞成功！");					
					document.getElementById(text_id).innerText = "点赞";					
					var fav_count = document.getElementById(count_id).innerText;
					fav_count = parseInt(fav_count) - 1;
					document.getElementById(count_id).innerText = fav_count;
				}
				if(data.fav_status == 2){
					alert("点赞成功！");
					document.getElementById(text_id).innerText = "已点赞";				
					var fav_count = document.getElementById(count_id).innerText;
					fav_count = parseInt(fav_count) + 1;
					document.getElementById(count_id).innerText = fav_count;
				}
				if(data.fav_status == 3){
					alert("操作失败");
				}
				if(data.fav_status == 4){
					alert("自己不能点赞自己的帖子");
				}
			}
		}
		,error:function(){
			alert("服务器提交错误");
		}
	});
}

function set_topic_reply(){
	$("#reply_id").val(0);
	$("#reply_user_id").val(0);
	$("#reply_user_name").val("");
	$("textarea[name='content']").val("");	
}

function set_reply(id,user_id,user_name){
		$("form[name='topic_reply_form']").find("input[name='reply_id']").val(id);
		if(user_name!='')
		$("textarea[name='content']").val("回复@"+user_name+"：");	
		$("#reply_user_id").val(user_id);
		$("#reply_user_name").val(user_name);
}
	
function delete_topic(topic_id,one_topic_obj){
	var query = new Object();
	query.topic_id = topic_id;
	query.post_type = "json";
	var ajaxurl = '{wap_url a="index" r="topicdel#index"}';
	//alert(query.topic_id);
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.status==1){ 
				one_topic_obj.hide();
				$("#topicdel").show();
				$("#topicdelmsg").html(data.info);
				//alert(data.info);
			}else{
				alert(data.info);
			}
		}
		,error:function(){
			alert("服务器提交错误");
		}
	});
}

function delete_topic_reply(topic_reply_id,one_reply_li_obj){
	var query = new Object();
	query.topic_reply_id = topic_reply_id;
	query.post_type = "json";
	var ajaxurl = '{wap_url a="index" r="topicreplydel#index"}';
	//alert(query.topic_reply_id);	
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.status==1){ 	
				one_reply_li_obj.hide();
				var topic_reply_count = $("#topic_reply_count").html();
				topic_reply_count = parseInt(topic_reply_count)-1;
				$("#topic_reply_count").html(topic_reply_count);
				alert(data.info);
			}else{
				alert(data.info);
			}
		}
		,error:function(){
			alert("服务器提交错误");
		}
	});
}

function  check(){	
	var form = $("form[name='topic_reply_form']")			
	var textarea = $(form).find("textarea");
	if($.trim(textarea.val())==''){
		alert("请输入内容");
		return false;
	}
	var query = new Object();
	query.content = textarea.val();
	query.topic_id = $("#topic_id").val();
	query.reply_id = $("#reply_id").val();
	query.reply_user_id = $("#reply_user_id").val();
	query.reply_user_name = $("#reply_user_name").val();
	query.post_type = "json";
	//alert(query.content+"--"+query.topic_id+"--"+query.post_type+"--"+query.reply_id+"--"+query.reply_user_id+"--"+query.reply_user_name);
	var ajaxurl = form.attr("action");
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.status==1){ 	
				alert(data.info);
				location.href='{wap_url a="index" r="topicitem#index"  p="id=$data.topic_item.id"}';
			}else{
				alert(data.info);
			}
		}
		,error:function(){
			alert("服务器提交错误");
		}
	});	
		return false;
	}
</script>					
{include file="./inc/footer.html"}				
			