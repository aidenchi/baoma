{include file="./inc/header_common.html"}
{include file="./inc/bbs_header_topbar.html"}
			
				<div class="wrap" id="wrap">
				{if $data.exit eq 1}
					<div class="blank8"></div>					
					<div class="list-view">
						<div style="padding:10px; line-height:20px; font-size:16px; border-bottom: 1px solid #f5f5f5; width:100%; color:#222;">
							<span>[讨论]&nbsp;{$data.topic_item.forum_title}</span>
						</div>
						<div style="padding:10px;border-bottom: 1px solid #f5f5f5; display: -webkit-box; color:#adadad;">							
							<div style="width:80px;text-align:center; ">
								{if $data.topic_item.user_id eq $data.user_id}
								<a href='{wap_url a="index" r="user_center#index"}'>
								{else}
								<a href='{wap_url a="index" r="userinfo#index" p="user_id=$data.topic_item.user_id"}'>
								{/if}
						 	    <img style="border-radius:50%; border:1px solid #bbb;" src='{function name="get_user_avatar" uid=$data.topic_item.user_id type="small" }' width="80" height="80">
								</a>
							</div>
							<div style="padding-left:12px;">
								<span style="color:#555; font-weight:bold; display:block;">{$data.topic_item.user_name}</span>
								<span style="padding:5px 0 5px 15px; display:block;">{function name="get_user_intro_byid" uid=$data.topic_item.user_id}</span>
								<span style="color:#555; display:block;">等级：{function name="get_user_level_byid" uid=$data.topic_item.user_id}</span>
							</div>
						</div>
						<div style="padding:10px;color:#adadad;">
							{$data.topic_item.content}
						</div>
						<div class="topic_bottom" style="padding:0 10px 10px;color:#adadad;text-align:right;">
							<span style="padding-right:5px;"><span class="am-icon-eye"></span>{$data.topic_item.hit_count}</span>
							<span style="cursor:pointer; padding-right:5px;" onclick="favorite_topic({$data.topic_item.id},{$data.topic_item.user_id})">
								{if $data.topic_item.is_fav eq 1}
								<font id="fav_text_{$data.topic_item.id}"><span id="fav_icon_{$data.topic_item.id}" class="am-icon-heart-o" style="color:#f90"></span></font>&nbsp;<font id="fav_count_{$data.topic_item.id}">{$data.topic_item.fav_count}</font>
								{else}
								<font id="fav_text_{$data.topic_item.id}"><span id="fav_icon_{$data.topic_item.id}" class="am-icon-heart-o"></span></font>&nbsp;<font id="fav_count_{$data.topic_item.id}">{$data.topic_item.fav_count}</font>
								{/if}
							</span>
							<span style="padding-right:5px;"><span class="am-icon-comment-o"></span><font id="topic_reply_count">{$data.topic_item.reply_count}</font></span>
							<span style="padding-left:20px;">{function name="pass_date" time=$data.topic_item.create_time }</span>
						</div>
					</div><!--list-view end-->
					
					{if $data.topic_item.reply_count gt 0}
					<div class="blank8"></div> 					
					<div class="list-view">
						 <ul class="">
						 {foreach from=$data.topic_reply_list item=topic_reply key=key}
							<li class="topic_item_reply_li" id="reply_item_{$topic_reply.id}">
						 	     <div class="list_item">
						 	    	 <div class="topic_user_headimg">
										{if $topic_reply.user_id eq $data.user_id}
										<a href='{wap_url a="index" r="user_center#index"}'>
										{else}
										<a href='{wap_url a="index" r="userinfo#index" p="user_id=$topic_reply.user_id"}'>
										{/if}
						 	    	 	<img src='{function name="get_user_avatar" uid=$topic_reply.user_id type="small" }'>
										</a>
						 	     	 </div>
									 <div class="info">										
										<div class="reply_topic_bottom">
						                    <p class="reply_topic_bottom_text">
												<em><i style="color:#4f8fd9;">{$topic_reply.user_name}</i><i style="margin:0 5px;">{function name="pass_date" time=$topic_reply.create_time }</i><font style="color:#222; font-size:12px;">说</font></em>					 
											</p>											
											<p class="reply_topic_bottom_text_right">
												<!--
												#{function name="floor_num" k=$key base_size=$data.base_size }
												-->
												<a href="#topic_reply" onclick="set_reply({$topic_reply.id},'{$topic_reply.user_id}','{$topic_reply.user_name}');"><span class="am-icon-reply"></span></a>
												{if $topic_reply.user_id eq $data.user_id}
												<a href="javascript:void(0);" onclick="delete_topic_reply_confirm({$topic_reply.id},$('#reply_item_{$topic_reply.id}'));"><span class="am-icon-remove"></span></a>
												{/if}
											</p>											
						                </div>
										<div class="reply_topic_bottom_p">
											<p class="content">{function name="nl2br" v=$topic_reply.content}</p>	
										</div>
									</div>
						 	     </div>
						 	</li>
						 {/foreach}
						 </ul>	
						{if $data.page.page_total gt 1}
						<div class="fy">
							{$pages}
						</div>
						{/if}
					</div><!--list-view end-->
					{/if}
					
					<div class="blank8"></div>
					<div id="topic_reply" style="border-top: 1px solid #e6e6e6; border-bottom: 1px solid #e6e6e6;">
					<form id="" name="topic_reply_form" method="post" action='{wap_url a="index" r="topicreply"}' onsubmit="return check(this);">
						<div class="topic_write_txt">
							<input type="hidden" name="topic_id" id="topic_id" value="{$data.topic_item.id}" />
							<input type="hidden" name="reply_id" id="reply_id" value="0" />
							<input type="hidden" name="reply_user_id" id="reply_user_id" value="0" />
							<input type="hidden" name="reply_user_name" id="reply_user_name" value="" />
							<textarea name="content" id="content" placeholder="请输入回复内容"></textarea>
							<div class="blank"></div>					
						</div>
						<div class="btn_login">
							<input type="submit" name="Submit" class="mj-submit" value="回复" style="background: none;">
						</div>
					</form>
					</div>					
			    {/if}
				{if $data.exit eq 0}
					<div style="margin-top:10px;margin-bottom:10px;text-align:center;">
					{$data.msg}
					</div>
				{/if}
				</div><!--wrap end-->	
				
				<!--帖子删除成功后的提示语-->
				<div id="topicdel" style="display:none;margin-top:10px;margin-bottom:10px;text-align:center;">
					<span id="topicdelmsg"></span>
				</div>

<script type="text/javascript">
function favorite_topic(topic_id,author_user_id){
	//alert(topic_id+"--"+author_user_id);
	var fav_icon_id = "fav_icon_"+topic_id;
	var text_id = "fav_text_"+topic_id;
	var count_id = "fav_count_"+topic_id;
	var query = new Object();
	query.topic_id = topic_id;
	query.author_user_id = author_user_id;
	query.post_type = "json";
	var ajaxurl = '{wap_url a="index" r="topicfavorite#index"}';

	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.user_login_status==0){
				//alert(data.login_info);
				$("#alert_content").html(data.login_info);
				$('#my-alert').modal({
					relatedTarget: this,
				});
			}else{
				if(data.fav_status == 1){									
					//document.getElementById(text_id).innerText = "点赞";	
					document.getElementById(fav_icon_id).style.color = "";						
					var fav_count = document.getElementById(count_id).innerText;
					fav_count = parseInt(fav_count) - 1;
					document.getElementById(count_id).innerText = fav_count;
					//alert("取消点赞成功！");	
					$("#alert_content").html("取消点赞成功！");
					$('#my-alert').modal({
						relatedTarget: this,
					});
					setTimeout(function(){
						$('#my-alert').modal('close');
					},1000);
				}
				if(data.fav_status == 2){					
					//document.getElementById(text_id).innerText = "已点赞";
					document.getElementById(fav_icon_id).style.color = "#f90";					
					var fav_count = document.getElementById(count_id).innerText;
					fav_count = parseInt(fav_count) + 1;
					document.getElementById(count_id).innerText = fav_count;
					//alert("点赞成功！");
					$("#alert_content").html("点赞成功！");
					$('#my-alert').modal({
						relatedTarget: this,
					});
					setTimeout(function(){
						$('#my-alert').modal('close');
					},1000);
				}
				if(data.fav_status == 3){
					//alert("操作失败");
					$("#alert_content").html("操作失败！");
					$('#my-alert').modal({
						relatedTarget: this,
					});
				}
				if(data.fav_status == 4){
					//alert("自己不能点赞自己的帖子");
					$("#alert_content").html("自己不能点赞自己的帖子！");
					$('#my-alert').modal({
						relatedTarget: this,
					});
					setTimeout(function(){
						$('#my-alert').modal('close');
					},1000);
				}
			}
		}
		,error:function(){
			//alert("服务器提交错误");
			$("#alert_content").html("服务器提交错误，请稍后重新操作");
			$('#my-alert').modal({
				relatedTarget: this,
			});
		}
	});
}

function set_topic_reply(){
	$("#reply_id").val(0);
	$("#reply_user_id").val(0);
	$("#reply_user_name").val("");
	$("textarea[name='content']").val("");	
}

function set_reply(id,user_id,user_name){
		$("form[name='topic_reply_form']").find("input[name='reply_id']").val(id);
		if(user_name!='')
		$("textarea[name='content']").val("回复@"+user_name+"：");	
		$("#reply_user_id").val(user_id);
		$("#reply_user_name").val(user_name);
}

function delete_topic_reply_confirm(topic_reply_id,one_reply_li_obj){
	 $("#confirm_content").html("您确定要删除这条回复吗");
	 $('#my-confirm').modal({
        relatedTarget: this,
        onConfirm: function(options) {
			delete_topic_reply(topic_reply_id,one_reply_li_obj);
        },
        onCancel: function() {
			
        }
      });
}

function delete_topic_reply(topic_reply_id,one_reply_li_obj){
	var query = new Object();
	query.topic_reply_id = topic_reply_id;
	query.post_type = "json";
	var ajaxurl = '{wap_url a="index" r="topicreplydel#index"}';
	//alert(query.topic_reply_id);	
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.status==1){ 	
				one_reply_li_obj.hide();
				var topic_reply_count = $("#topic_reply_count").html();
				topic_reply_count = parseInt(topic_reply_count)-1;
				$("#topic_reply_count").html(topic_reply_count);
				/*
				$("#alert_content").html("删除成功");
				$('#my-alert').modal({
					relatedTarget: this,
				});
				*/
				location.reload();
			}else{
				//alert(data.info);
				$("#alert_content").html(data.info);
				$('#my-alert').modal({
					relatedTarget: this,
				});
			}
		}
		,error:function(){
			//alert("服务器提交错误");
			$("#alert_content").html("服务器提交错误，请稍后重新操作");
			$('#my-alert').modal({
				relatedTarget: this,
			});
		}
	});
}

function  check(){	
	var form = $("form[name='topic_reply_form']")			
	var textarea = $(form).find("textarea");
	if($.trim(textarea.val())==''){
		//alert("请输入内容");
		$("#alert_content").html("请输入回复内容");
		$('#my-alert').modal({
			relatedTarget: this,
		});
		setTimeout(function(){
			$('#my-alert').modal('close');
		},1000);
		return false;
	}
	var query = new Object();
	query.content = textarea.val();
	query.topic_id = $("#topic_id").val();
	query.reply_id = $("#reply_id").val();
	query.reply_user_id = $("#reply_user_id").val();
	query.reply_user_name = $("#reply_user_name").val();
	query.post_type = "json";
	//alert(query.content+"--"+query.topic_id+"--"+query.post_type+"--"+query.reply_id+"--"+query.reply_user_id+"--"+query.reply_user_name);
	var ajaxurl = form.attr("action");
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){
			if(data.status==1){ 	
				location.href='{wap_url a="index" r="topicitem#index"  p="id=$data.topic_item.id"}';		
			}else{
				//alert(data.info);
				$("#alert_content").html(data.info);
				$('#my-alert').modal({
					relatedTarget: this,
				});
			}
		}
		,error:function(){
			//alert("服务器提交错误");
			$("#alert_content").html("服务器提交错误，请稍后重新操作");
			$('#my-alert').modal({
				relatedTarget: this,
			});
		}
	});	
		return false;
	}
</script>					

<div class="amz-toolbar" id="amz-toolbar">
<a href="#top" title="回到顶部" class="am-icon-btn am-icon-arrow-up am-active" id="amz-go-top"></a>
</div>		
			