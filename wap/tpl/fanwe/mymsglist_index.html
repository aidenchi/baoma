<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />	
    <!-- Mobile Devices Support @begin -->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="false" name="twcClient" id="twcClient">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <!--允许全屏模式-->
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <!--指定sari的样式-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta content="telephone=no" name="format-detection" />
    <!-- Mobile Devices Support @end -->
	<title>{$data.page_title}</title>
	{include file="./inc/common.html"}
</head> 
<body>
	{include file="./inc/header.html"}
	{include file="./inc/pop.html"}
	
			<div class="wrap">
				<div class="content">
					<div class="blank8"></div>
					<div class="list-view">
						<div class="list_title">
							我的私信(共<span id="my_msg_count">{$data.msg_count}</span>条)
							<i style="float:right;font-size:12px;"><a href='{wap_url a="index" r="mymsgdetail#index"}'>写私信</a></i>
						</div>
						{if $data.msg_list}
						<div style="padding-left:10px;padding-top:5px;">
							<input type="checkbox" name="checkall" />
							<a style="padding-left:18px;" href="javascript:void(0);" onclick="delete_msg()">删除</a>
						</div>
						<form name="pm_list">	
						 <table cellspacing="0" cellpadding="0" border="0" class="msg_list_table">
							<tbody>
								{foreach from=$data.msg_list item=msg_item}
								<tr class="pm_row">
									<td width="15">					
										<input type="checkbox" value="{$msg_item.group_key}" name="pm_key[]">					
									</td>
									<td width="15">
										{if $msg_item.system_msg_id neq 0 or $msg_item.is_notice}<span class="pm_pic"></span>{/if}
										{if $msg_item.system_msg_id eq 0 and $msg_item.is_notice eq 0}
											{if $msg_item.to_user_id eq $data.login_user_id}
											<a href='{wap_url a="index" r="userinfo#index" p="user_id=$msg_item.from_user_id"}'>
												<img src='{function name="get_user_avatar" uid=$msg_item.from_user_id type="small" }'>
											</a>
											{/if}
											{if $msg_item.from_user_id eq $data.login_user_id}
											<a href='{wap_url a="index" r="userinfo#index" p="user_id=$msg_item.to_user_id"}'>
												<img src='{function name="get_user_avatar" uid=$msg_item.to_user_id type="small" }'>
											</a>
											{/if}
										{/if}
									</td>									
									<td style="text-align:left;">										
										{if $msg_item.type eq 0 and $msg_item.is_read eq 0}<span class="new_pm"></span>{/if}		
										{if $msg_item.system_msg_id neq 0 or $msg_item.is_notice}
											{if $msg_item.is_notice}
												系统通知:
											{else}
												系统消息:
											{/if}
											<span style="font-weight:bolder;">{$msg_item.title}</span>
										{/if}
										{if $msg_item.system_msg_id eq 0 and $msg_item.is_notice eq 0}		
											{if $msg_item.from_user_id eq $data.login_user_id}
												我
											{else}
												<a href='{wap_url a="index" r="userinfo#index" p="user_id=$msg_item.to_user_id"}'>
												{function name="get_user_name_by_user_id" v=$msg_item.from_user_id"}
												</a>
											{/if}
												对
											{if $msg_item.to_user_id eq $data.login_user_id}
												我
											{else}
												<a href='{wap_url a="index" r="userinfo#index" p="user_id=$msg_item.to_user_id"}'>
												{function name="get_user_name_by_user_id" v=$msg_item.to_user_id}
												</a>
											{/if}
												说:									
										{/if}
										<br />
										<a href='{wap_url a="index" r="mymsgdetail#index" p="id=$msg_item.group_key"}'>
											{function name="msubstr" v=$msg_item.content b=0 e=15}
										</a>&nbsp;&nbsp;
										<a href='{url a="index" r="mymsgdetail#index" p="id=$msg_item.group_key"}' class="view_pm">
											{if $msg_item.system_msg_id eq 0 and $msg_item.type eq 0 and $msg_item.is_notice eq 0}
												[查看回复]
											{else}
												[查看]			
											{/if}			
										</a>								
									</td>
									<td width="80" style="text-align:right;">
										{function name="sprintf" f=共%s封 v=$msg_item.total}
										<br />
										{function name="pass_date" v=$msg_item.create_time}			
									</td>
								</tr>				
							{/foreach}								
							</tbody>
						</table>
						{if $data.page.page_total gt 1}  
						<div class="fy">
							{$pages}
						</div>
						</form>
						{/if}
						{else}
						<div class="assess_list" style="text-align:center;padding:10px 0;">暂无私信</div>
						{/if}
					</div><!--list-view end-->
				</div>
			</div>
	
	{include file="./inc/footer.html"} 
	
	<script type="text/javascript">
	$(document).ready(function(){
		$("input[name='checkall']").click(function(){    
			if(this.checked){    
				$("input[name='pm_key[]']").attr("checked", true);   
			}else{    
				$("input[name='pm_key[]']").attr("checked", false); 
			}    
		});
	});

	function delete_msg(){
		var cbos = $("input[name='pm_key[]']:checked");
		if(cbos.length==0){
			//alert("请选中您要删除的消息记录");
			$("#alert_content").html("请选中您要删除的消息记录！");
			$('#my-alert').modal({
				relatedTarget: this,
			});
			setTimeout(function(){
				$('#my-alert').modal('close');
			},2000);
		}else{
			 $("#confirm_content").html("您确定要删除选中的消息记录吗");
			 $('#my-confirm').modal({
				relatedTarget: this,
				onConfirm: function(options) {
					var group_keys = $("input[name='pm_key[]']:checked");
					//alert(group_keys.length);
					var group_keys_val = "";
					for (var i=0; i < group_keys.length; i++) {
						group_key_val = group_keys[i].value;
						group_keys_val = group_keys_val+","+group_key_val;
					}
					//alert(group_keys_val);
					var query = new Object();
					query.group_keys_val = group_keys_val;
					query.post_type = "json";
					var ajaxurl = '{wap_url a="index" r="mymsgdelbykey#index"}';
					$.ajax({
						url:ajaxurl,
						data:query,
						type:"post",
						dataType:"json",
						success:function(data){
							//alert(data.group_keys_val);
							location.reload();
						}
						,error:function(){
							//alert("服务器提交错误");
							$("#alert_content").html("服务器提交错误，请稍后重新操作");
							$('#my-alert').modal({
								relatedTarget: this,
							});
						}
					});
				},
				onCancel: function() {
					
				}
			  });
		}
	}
	</script>
	
</body>
</html>	
	