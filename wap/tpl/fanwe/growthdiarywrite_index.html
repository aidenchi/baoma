{include file="./inc/header_common.html"}
			<div class="header">
				<div class="c-hd">
					<section class="cut_city">
						  <a onclick="window.history.go(-1);" style="cursor:pointer;">取消</a>
					</section>
					<section class="logo_img"></section>
					<section style="padding:10px 10px;display:inline-block;position:relative;font-size: 18px;">
						<a onclick="check_submit();" style="color:#fff;cursor:pointer;">发送</a>
					</section>
				 </div>	 
			</div>	
			
			<div class="wrap">
					<div class="content">
					 <div class="comment_list_txt">
						<form id="growth_dairy_add_form" action='' autocomplete="off" method="post" onsubmit="return check(this)">		 
						 <div class="Contentbox">
								<input type="hidden" name="growth_dairy_id" id="growth_dairy_id" value="{$data.id}">	   
								<div class="topic_write_txt">
									<textarea name="content" id="content" placeholder="请输入内容">{$data.growth_diary_item.content}</textarea>
								</div>	
								<!--
								<div style="margin-left:10px;">									
									<label class="growth_pic_fileupload" onclick="up_file(this,'topic_image');" >
										<input type="file" class="filebox" name="topic_image" id="topic_image">
									</label>
									<label class="growth_pic_fileuploading hide">正在上传…</label>
									<div id="image_box"></div>
								</div>
								-->
								<div class="inputtxt1" style="margin-top:0px;">
									<div class="input_sr"><input type="text" placeholder="所在位置" name="location" id="location" value="{$data.growth_diary_item.location}" onclick="get_location()"></div>
								</div>
								<div class="inputtxt2 chk2"> 
									<span class="chk_sp1">权限:</span>
									<input class="mt_sex" type="radio" name="is_public" value="1" /><span class="chk_sp2">公开</span>
									<input class="mt_sex" type="radio" name="is_public" value="0" checked="checked"/><span class="chk_sp2">私密</span>
								</div>								
						 </div>	            
						</form>
					 </div><!--comment_list_txt end-->
					</div><!--content end-->				
				 
				</div><!--wrap end-->

<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>	
<script type="text/javascript" src="./js/ajaxupload.js"></script>			
<script type="text/javascript">
function up_file(obj,file_id)
{	
	$("input[name='"+file_id+"']").bind("change",function(){		
		//$(obj).hide();
		$(obj).parent().parent().find(".growth_pic_fileuploading").removeClass("hide");
		$(obj).parent().parent().find(".growth_pic_fileuploading").removeClass("show");
		$(obj).parent().parent().find(".growth_pic_fileuploading").addClass("show");
		  $.ajaxFileUpload
		   (
			   {
				    url:'/upload.php',
				    secureuri:false,
				    fileElementId:file_id,
				    dataType: 'json',
				    success: function (data, status)
				    {
				   		//$(obj).show();
				   		$(obj).parent().parent().find(".growth_pic_fileuploading").removeClass("hide");
						$(obj).parent().parent().find(".growth_pic_fileuploading").removeClass("show");
						$(obj).parent().parent().find(".growth_pic_fileuploading").addClass("hide");
				   		if(data.error==0)
				   		{	
							//var str = data.message;
							//data.message = str.substring(1);
							var pos = parseInt($("#image_box").find(".image_item").length) + 1;
							//var html = "<div class='image_item'><input type='hidden' name='topic_image_idx["+pos+"]' value='"+pos+"' /><input type='hidden' name='topic_image_id["+pos+"]' value='"+data.id+"' /><input type='hidden' name='topic_image_url["+pos+"]' value='"+data.message+"' /><span class='del_image' onclick='del_img(this);'>x</span><a href='javascript:;' onclick='set_img_pos("+data.id+")' title='点击图片可在指定位置插入该图片' ><img src='"+APP_ROOT+"/"+data.message+"' /></a></div>";
							var html = "<div class='image_item'><input type='hidden' name='topic_image_idx["+pos+"]' value='"+pos+"' /><input type='hidden' name='topic_image_id["+pos+"]' value='"+data.id+"' /><input type='hidden' name='topic_image_url["+pos+"]' value='"+data.message+"' /><span class='del_image' onclick='del_img(this);'>x</span><img src='"+data.message+"' /></div>";
							$("#image_box").html($("#image_box").html()+html);
				   			$("#form_pop_box").hide();
							//$("textarea[name='{$text_name}']").val($("textarea[name='{$text_name}']").val()+"[img]"+data.id+"[/img]");
				   		}
				   		else
				   		{
				   			//$.showErr(data.message);
							alert(data.message);
				   		}
				   		
				    },
				    error: function (data, status, e)
				    {
						//$.showErr(data.responseText);
						alert(data.responseText);
				    	$(obj).show();
				    	$(obj).parent().parent().find(".growth_pic_fileuploading").removeClass("hide");
						$(obj).parent().parent().find(".growth_pic_fileuploading").removeClass("show");
						$(obj).parent().parent().find(".growth_pic_fileuploading").addClass("hide");
				    }
			   }
		   );
		  $("input[name='"+file_id+"']").unbind("change");
	});	
}

function del_img(o){
	$(o).parent().remove();
}

function get_location(){
	$("#location").val("正在定位…");
	var geolocation = new BMap.Geolocation(); 
	var geoc = new BMap.Geocoder(); 
	geolocation.getCurrentPosition(function (r) { 	
		if (this.getStatus() == BMAP_STATUS_SUCCESS ) { 
			origin = r.point.lng + "," + r.point.lat; 			
			//alert("我所在位置的坐标："+origin); 
			var pt = r.point;
            geoc.getLocation(pt, function(rs){
                //alert(rs.address);
				$("#location").val(rs.address);
            }); 
		}else{
			alert('定位失败');
			$("#location").val("");
		}
	});	
}

function  check_submit(){	
	var flag = true;
	if($.trim($("#content").val())==''){
		alert("请输入内容");
		flag = false;
	}
	var is_public = document.getElementsByName("is_public");
	var is_public_val = "";
	var is_public_flag = false;
	for (var i=0; i < is_public.length; i++) {
		if (is_public.item(i).checked) {
			is_public_flag = true
			is_public_val = is_public.item(i).value;
			break;
		}
	}
	if(!is_public_flag){
		alert("请选择权限");
		flag = false;
	}
	
	var query = new Object();
	query.id = $("#growth_dairy_id").val();
	query.content = $("#content").val();
	query.location = $("#location").val();
	query.is_public = is_public_val;
	query.post_type = "json";
	//alert(query.is_public);
	var ajaxurl = '{wap_url a="index" r="growthdiaryadd"}';
	if(flag){
		$.ajax({
			url:ajaxurl,
			data:query,
			type:"post",
			dataType:"json",
			success:function(data){
				if(data.status==1){ 	
					alert(data.info);
					if(data.action_flag == 1){
						window.location.href='{wap_url a="index" r="growthdiaryitem#index" p="id=$data.id"}';					
					}else{
						window.location.href='{wap_url a="index" r="growthdiarylist#index"}';
					}
				}else{
					alert(data.info);
				}
			}
			,error:function(){
				alert("服务器提交错误");
			}
		});	
	}
}
</script>	
				
{include file="./inc/footer.html"}				
			