{if $is_ajax eq 1}
{include file="./inc/nearbyuserlist_key_item.html"}
<?php die();?>
{/if}


<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />	
    <!-- Mobile Devices Support @begin -->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="false" name="twcClient" id="twcClient">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <!--允许全屏模式-->
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <!--指定sari的样式-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta content="telephone=no" name="format-detection" />
    <!-- Mobile Devices Support @end -->
	<title>{$data.page_title}</title>
	{include file="./inc/common.html"}
</head> 
<body>
	{include file="./inc/header.html"}
	{include file="./inc/pop.html"}


	<!--ajax 刷新数据部分 start-->
	<div id="ajax_user_list">
		{include file="./inc/nearbyuserlist_key_item.html"}
	</div><!--ajax_user_list end-->
	<!--ajax 刷新数据部分 end-->
	
	{include file="./inc/footer.html"}	

	<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
	<script>
	$(document).ready(function () {	
		if($("#hide_xpoint").val()>0){//如果定位坐标有值或位置有值
		
		}else{//如果定位坐标没有值，也没有选择位置，则执行定位获取坐标读取我附近
			get_nearby_user();
		}
	});

	function get_nearby_user(){
		$(".more_search_pull_down").hide();	
		if($("#hide_xpoint").val()>0 && $("#hide_ypoint").val()>0){
			ajaxgetbyxypoint($("#hide_xpoint").val(),$("#hide_ypoint").val(),'all');	
		}else{
			//$("#loading").show();
			$('#loading_content').html("正在定位……");
			$('#my-loading').modal({
				relatedTarget: this,
			});
			var geolocation = new BMap.Geolocation(); 
			var geoc = new BMap.Geocoder(); 
			geolocation.getCurrentPosition(function (r) { 			
				
				if (this.getStatus() == BMAP_STATUS_SUCCESS ) { 
					$('#my-loading').modal('close');
					//origin = r.point.lng + "," + r.point.lat; 			
					//alert("我所在位置的坐标："+origin); 
					var longitude=r.point.lng;
					var latitude=r.point.lat;			
					var pt = r.point;
					geoc.getLocation(pt, function(rs){
						//alert(rs.address);
						var location = rs.address;
						userxypoint(longitude,latitude,location);
					});
				/*	
				//模拟
				if(1==1){
					var longitude=114.41776;
					var latitude=30.483698;	
				*/
					$("#hide_xpoint").val(longitude);
					$("#hide_ypoint").val(latitude);
					ajaxgetbyxypoint(longitude,latitude,'all');				
				}else{
					//alert("定位失败，请稍后刷新重试");
					//$("#loading").hide();
					$('#my-loading').modal('close');
					$("#alert_content").html("定位失败，请稍后刷新重试");
					$('#my-alert').modal({
						relatedTarget: this,
					});
					setTimeout(function(){
						$('#my-alert').modal('close');
					},2000);
					ajaxgetbyxypoint(0,0,'all');
				}
			});	
		}
	}

	function ajaxgetbyxypoint(longitude,latitude,distance){
		//alert("ajaxgetbyxypoint");
		var ajaxurl = '{wap_url a="index" r="nearbyuserlist"}';
		var query = new Object();
		query.sex = $("#hide_sex").val();
		query.xpoint = longitude;
		query.ypoint = latitude;
		query.distance = distance;
		query.is_ajax=1;
		$.ajax({
			url:ajaxurl,
			data:query,
			type:"Post",
			dataType:"text",
			success:function(data){
				//alert("yes");
				$("#ajax_user_list").html(data);
			}
			,error:function(){
				//alert("服务器提交错误");
			}
		});	
	}

	//如果当前用户是登录状态，记录它的坐标
	function userxypoint(longitude,latitude,location){	
		//alert("userxypoint");
		var query = new Object();
		query.latitude = latitude;
		query.longitude = longitude;
		query.location = location;
		//alert(query.latitude+"--"+query.longitude+"--"+query.location);
		query.post_type = "json";
		var ajaxurl = '{url a="index" r="userxypoint"}';
		$.ajax({
			url:ajaxurl,
			data:query,
			type:"post",
			dataType:"json",
			success:function(data){		
				//alert("userxypoint--yes");
			}
			,error:function(){	
				//alert("userxypoint--no");
			}
		});		 		
	}

	//根据昵称查询
	function keySearch(){
	  if (event.keyCode==13)   //回车键的键值为13
		 search_submit();  //调用登录按钮的登录事件
	}

	function search_submit(){			
		var keyword=$("#keyword").val();
		var ajaxurl = '{wap_url a="index" r="nearbyuserlist"}';
		var query = new Object();
		query.keyword = keyword;
		query.xpoint = $("#hide_xpoint").val();
		query.ypoint = $("#hide_ypoint").val();
		query.distance = "all";
		query.is_ajax=1;
		//alert(query.keyword);
		$.ajax({
			url:ajaxurl,
			data:query,
			type:"Post",
			dataType:"text",
			success:function(data){
				//alert(data);
				$("#ajax_user_list").html(data);
			}
			,error:function(){
				//alert("服务器提交错误");
				$("#alert_content").html("服务器提交错误，请稍后重新操作");
				$('#my-alert').modal({
					relatedTarget: this,
				});
			}
		});	
	}
	</script>
			
</body>
</html>				
			