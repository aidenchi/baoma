{if $is_ajax eq 1}
{include file="./inc/nearbyuserlist_key_item.html"}
<?php die();?>
{/if}
{include file="./inc/header_common.html"}
<style>
.nearby_user_list_table {
	width:100%;
	color: #adadad;
	font-size:12px;
}
.nearby_user_list_table td {
	line-height: 22px;
	padding: 10px;
	height: 100px;
	border-bottom: 1px solid #f5f5f5;
}
</style>

<!--ajax 刷新数据部分 start-->
<div id="ajax_user_list">
	{include file="./inc/nearbyuserlist_key_item.html"}
</div><!--ajax_user_list end-->
<!--ajax 刷新数据部分 end-->

<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
<script>
$(document).ready(function () {	
	if($("#hide_xpoint").val()>0){//如果定位坐标有值或位置有值
	
	}else{//如果定位坐标没有值，也没有选择位置，则执行定位获取坐标读取我附近
		get_nearby_user();
	}
});

function get_nearby_user(){
	$(".more_search_pull_down").hide();	
	if($("#hide_xpoint").val()>0 && $("#hide_ypoint").val()>0){
		ajaxgetbyxypoint($("#hide_xpoint").val(),$("#hide_ypoint").val(),'all');	
	}else{
		$("#loading").show();
		var geolocation = new BMap.Geolocation(); 
		geolocation.getCurrentPosition(function (r) { 			
			/*
			if (this.getStatus() == BMAP_STATUS_SUCCESS ) { 
				//origin = r.point.lng + "," + r.point.lat; 			
				//alert("我所在位置的坐标："+origin); 
				var longitude=r.point.lng;
				var latitude=r.point.lat;	
			*/
			//模拟
			if(1==1){
				var longitude=114.41776;
				var latitude=30.483698;			
				$("#hide_xpoint").val(longitude);
				$("#hide_ypoint").val(latitude);
				ajaxgetbyxypoint(longitude,latitude,'all');
				userxypoint(longitude,latitude);
			}else{
				alert("定位失败，请稍后刷新重试");	
				ajaxgetbyxypoint(0,0,'all');
			}
		});	
	}
}

function ajaxgetbyxypoint(longitude,latitude,distance){
	//alert("ajaxgetbyxypoint");
	var ajaxurl = '{wap_url a="index" r="nearbyuserlist"}';
	var query = new Object();
	query.sex = $("#hide_sex").val();
	query.xpoint = longitude;
	query.ypoint = latitude;
	query.distance = distance;
	query.is_ajax=1;
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"Post",
		dataType:"text",
		success:function(data){
			//alert("yes");
			$("#ajax_user_list").html(data);
		}
		,error:function(){
			alert("服务器提交错误");
		}
	});	
}

//如果当前用户是登录状态，记录它的坐标
function userxypoint(longitude,latitude){	
	//alert("userxypoint");
	var query = new Object();
	query.latitude = latitude;
	query.longitude = longitude;
	query.post_type = "json";
	var ajaxurl = '{url a="index" r="userxypoint"}';
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){		
			//alert("userxypoint--yes");
		}
		,error:function(){	
			//alert("userxypoint--no");
		}
	});		 		
}
</script>

			
<!------------------------------------------footer-------------------------------------------->				
{include file="./inc/footer.html"}				
			