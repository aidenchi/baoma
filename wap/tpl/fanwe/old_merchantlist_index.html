{if $is_ajax eq 1}
{include file="./inc/merchantlist_key_item.html"}
<?php die();?>
{/if}
{include file="./inc/header.html"} 
<?php
		$this->_var['parse_pagecss'][] = $this->_var['TMPL_REAL']."/css/merchantlist_index.css";	
			
?>
<link rel="stylesheet" type="text/css" href='{function name="parse_css" v="$parse_pagecss"}' />


<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
<script type="text/javascript">
/*
$(document).ready(function(){
	if($("#hide_xpoint").val()>0 || $("#hide_quan_id").val()>0){//如果定位坐标有值或位置有值
		//alert($("#hide_xpoint").val()+"yes--"+$("#hide_quan_id").val());
	}else{//如果定位坐标没有值，也没有选择位置，则执行定位获取坐标读取我附近
		//alert("no--"+$("#hide_quan_id").val());
		get_nearby_store();
	}
});
*/
function get_nearby_store(){	
	//alert("get_nearby_store");	
	$("#loading").show();
	var geolocation = new BMap.Geolocation(); 
	geolocation.getCurrentPosition(function (r) { 
		if (this.getStatus() == BMAP_STATUS_SUCCESS ) { 
			origin = r.point.lng + "," + r.point.lat; 			
			//alert("我所在位置的坐标："+origin); 
			var longitude=r.point.lng;
			var latitude=r.point.lat;
			window.location.href=$("#nearby_part_href").val()+"&xpoint="+longitude+"&ypoint="+latitude;//定位成功，读取我所在位置附近
			$("#loading").hide();
		}else{
			alert("定位加载失败，请稍后重试");
			window.location.href=$("#nearby_part_href").val()+"&quan_id=1";//定位失败，读取全部位置
			//$("#loading_img").hide();
			//$("#loading_text").html("定位加载失败");
		}
	});	
}

/*
//将坐标返回到服务端;
function userxypoint(latitude,longitude){	 	
	var query = new Object();
	query.latitude = latitude;
	query.longitude = longitude;
	query.post_type = "json";
	var ajaxurl = '{url a="index" r="userxypoint"}';
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){					
		}
		,error:function(){					
		}
	});		 		
}
*/
</script>	


<div class="wrap">
	<div class="search_box_tx">
    	<div class="search_text_tx"> 
			<a class="search_ico_tx"><i class="fa fa-search"></i></a>
			<input type="text" placeholder="请输入商家名称" id="keyword">
		</div>
		<div class="search_button_tx">
			<input type="Button" value="搜索" onclick="search_submit()">
			<input type="hidden" value="{$data.is_auto_order}" id="J_is_auto_order">
		</div>
    </div>
	<div class="blank8"></div>
	
	<!--筛选条件-->
    <div class="list-view" id="J_key_item">
		<div class="list_title">筛选</div><!--{$data.test}<br/>{$data.xypoint}<br/>{$data.quan_id}<br/>{$data.sql}-->
		<input type="hidden" id="hide_xpoint" name="hide_xpoint" value={$data.xpoint} />
		<input type="hidden" id="hide_quan_id" name="hide_quan_id" value={$data.quan_id} />
		<input type="hidden" id="nearby_part_href" name="nearby_part_href" value="index.php?ctl=merchantlist&cate_id={$data.cate_id}&age_id={$data.age_id}" /
		<ul>
			<li class="choose_li">
				<div class="choose_item">
					<div class="choose_title">
						类别：
					</div>
					<div class="choose_content">
						{foreach from=$data.bcate_list item='cate'}
							<i {if $data.cate_id eq $cate.id} class="selected" {/if}><a href='index.php?ctl=merchantlist&cate_id={$cate.id}&quan_id={$data.quan_id}&order_type={$data.order_type}&age_id={$data.age_id}&xpoint={$data.xpoint}&ypoint={$data.ypoint}'>{$cate.name}</a></i>
						{/foreach}
					</div>
				</div>
			</li>
			<li class="choose_li">
				<div class="choose_item">
					<div class="choose_title">
						位置：
					</div>
					<div class="choose_content">							
						{foreach from=$data.quan_list item='quan'}
							{if $quan.id eq 0}
							<i {if $data.quan_id eq 1 and $data.xpoint <= 0} class="selected" {/if}>								
								<a href='index.php?ctl=merchantlist&cate_id={$data.cate_id}&quan_id=all&order_type={$data.order_type}&age_id={$data.age_id}'>{$quan.name}</a>
							</i>
							{else}
							<i {if $data.quan_id eq $quan.id} class="selected" {/if}>								
								<a href='index.php?ctl=merchantlist&cate_id={$data.cate_id}&quan_id={$quan.id}&order_type={$data.order_type}&age_id={$data.age_id}'>{$quan.name}</a>
							</i>
							{/if}
						{/foreach}						
					</div>
				</div>
			</li>
			<li class="choose_li">
				<div class="choose_item">
					<div class="choose_title">
						排序：
					</div>
					<div class="choose_content"><!--index.php?ctl=merchantlist&cate_id={$data.cate_id}&age_id={$data.age_id}&xpoint=114.41776&ypoint=30.483698-->					
						<i {if $data.xpoint gt 0 and $data.ypoint gt 0} class="selected" {/if}>								
							<a id="nearby_store" href='javascript:void(0);' onclick="get_nearby_store()">离我最近</a>
						</i>
						<i {if $data.order_type eq 'dp_count'} class="selected" {/if}><a href='index.php?ctl=merchantlist&cate_id={$data.cate_id}&quan_id={$data.quan_id}&order_type=dp_count&age_id={$data.age_id}&xpoint={$data.xpoint}&ypoint={$data.ypoint}'>人气最高</a></i>
						<i {if $data.order_type eq 'avg_point'} class="selected" {/if}><a href='index.php?ctl=merchantlist&cate_id={$data.cate_id}&quan_id={$data.quan_id}&order_type=avg_point&age_id={$data.age_id}&xpoint={$data.xpoint}&ypoint={$data.ypoint}'>评价最好</a></i>
						<i {if $data.order_type eq 'id'} class="selected" {/if}><a href='index.php?ctl=merchantlist&cate_id={$data.cate_id}&quan_id={$data.quan_id}&order_type=id&age_id={$data.age_id}&xpoint={$data.xpoint}&ypoint={$data.ypoint}'>最新发布</a></i>
					</div>
				</div>
			</li>
			<li class="choose_li">
				<div class="choose_item">
					<div class="choose_title">
						年龄：
					</div>
					<div class="choose_content">
						{foreach from=$data.age_list item='age'}
							<i {if $data.age_id eq $age.id} class="selected" {/if}><a href='index.php?ctl=merchantlist&cate_id={$data.cate_id}&quan_id={$data.quan_id}&order_type={$data.order_type}&age_id={$age.id}&xpoint={$data.xpoint}&ypoint={$data.ypoint}'>{$age.name}</a></i>
						{/foreach}
					</div>
				</div>
			</li>
		</ul>		
		</div>
	</div>
	
	<!--店铺列表-->
	<div class="content">
		<div class="list-view" id="J_key_item">
			<div class="list_title"><span id="store_count">{$data.total}</span>家</div>
			<!--定位加载-->
			<div id="loading" style="display:none;text-align:center;padding:10px 0;">
				<img id="loading_img" src="./images/loading.gif" /><br/><span id="loading_text">正在定位加载您附近的店铺…</span>
			</div>
			{include file="./inc/merchantlist_key_item.html"}			
		</div>
	</div>

<script type="text/javascript">		
			function  search_submit(){			
				var keyword=$("#keyword").val();
				var is_auto_order=$("#J_is_auto_order").val();
				var ajaxurl = '{wap_url a="index" r="merchantlist"}';
				var query = new Object();
				query.keyword = keyword;
				query.age_id = 5;
				if(is_auto_order != null){
					query.is_auto_order = is_auto_order;
				}
				query.is_ajax=1;
				$.ajax({
					url:ajaxurl,
					data:query,
					type:"Post",
					dataType:"text",
					success:function(data){
						$("#J_key_item").html(data);
					}
					,error:function(){
						//alert("服务器提交错误");
					}
				});	
			}
		
</script>

{include file="./inc/footer.html"} 