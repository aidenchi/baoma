<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />	
    <!-- Mobile Devices Support @begin -->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="false" name="twcClient" id="twcClient">
    <meta content="no-cache,must-revalidate" http-equiv="Cache-Control">
    <meta content="no-cache" http-equiv="pragma">
    <meta content="0" http-equiv="expires">
    <!--允许全屏模式-->
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <!--指定sari的样式-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta content="telephone=no" name="format-detection" />
    <!-- Mobile Devices Support @end -->
	<title>{$data.page_title}</title>
	{include file="./inc/common.html"}
</head> 
<body>
	{include file="./inc/header.html"}
	{include file="./inc/pop.html"}

	<form class="am-form" style="padding:10px;" id="myinfo_form" action='{wap_url a="index" r="myinfosave#index"}' autocomplete="off" method="post" onsubmit="return check(this)">
	  <fieldset>
		<div class="am-form-group">
			<label for="doc-ipt-email-1">头像</label><br/>
		    <img id="avatar" src='{function name="get_user_avatar" uid=$data.uid type="middle"}' />
			<div class="blank8"></div>
			<label style="margin-left:30px;" class="fileupload" onclick="upd_file(this,'avatar_file',{$data.uid});">
			<input type="file" class="filebox" name="avatar_file" id="avatar_file"/>
			</label>
			<label style="margin-left:30px;" class="fileuploading hide" ></label>
		</div>		
		<div class="am-form-group">
		  <label for="doc-ipt-pwd-1">昵称</label>
		  <input type="text" class="" id="user_name" name="user_name" value="{$data.user_name}">
		</div>		
		<div class="am-form-group">
		  <label for="doc-select-1">性别</label>
		  <select id="sex" name="sex">
			<option value="1" {if $data.sex eq 1}selected="true"{/if} >男</option>
			<option value="0" {if $data.sex eq 0}selected="true"{/if} >女</option>
		  </select>
		  <span class="am-form-caret"></span>
		</div>
		<div class="am-form-group am-form-icon">
			<label for="doc-select-1">出生日期</label>
			<input type="text" class="am-form-field" placeholder="出生日期" name="birth" id="birth" value="{$data.byear}-{$data.bmonth}-{$data.bday}" data-am-datepicker readonly/>
		</div>
		
		<div class="am-form-group">
		  <label for="doc-ipt-email-1">Email</label>
		  <input type="email" class="" id="user_email" name="user_email" placeholder="输入电子邮件" value="{$data.email}">
		</div>
		<div class="am-form-group">
		  <label for="doc-ta-1">个人简介</label>
		  <textarea class="" rows="5" id="my_intro" name="my_intro" maxlength=50 placeholder="点击输入您的个人简介，最多50字">{$data.my_intro}</textarea>
		</div>
		<div class="am-form-group" style="text-align:center;">
		<p><button type="submit" class="am-btn am-btn-default">提交</button></p>
		<div>
	  </fieldset>
	</form>
	
	<div class="amz-toolbar" id="amz-toolbar">
		<a href="#top" title="回到顶部" class="am-icon-btn am-icon-arrow-up am-active" id="amz-go-top"></a>
	</div>	

	<script type="text/javascript" src="./js/ajaxupload.js"></script>	
	<script type="text/javascript">
	function upd_file(obj,file_id,uid)
	{	
		$("input[name='"+file_id+"']").bind("change",function(){			
			$('#loading_content').html("正在上传……");
			$('#my-loading').modal({
				relatedTarget: this,
			});
			  $.ajaxFileUpload
			   (
				   {
						url:'/avatarupload.php?uid='+uid,
						secureuri:false,
						fileElementId:file_id,
						dataType: 'json',
						success: function (data, status)
						{
							$('#my-loading').modal('close');
							if(data.status==1)
							{
								document.getElementById("avatar").src = data.middle_url+"?r="+Math.random();
							}
							else
							{
								//alert(data.msg);
								$("#alert_content").html(data.msg);
								$('#my-alert').modal({
									relatedTarget: this,
								});
							}
							
						},
						error: function (data, status, e)
						{
							//alert(data.responseText);
							$('#my-loading').modal('close');
							$("#alert_content").html(data.responseText);
							$('#my-alert').modal({
									relatedTarget: this,
							});
						}
				   }
			   );
			  $("input[name='"+file_id+"']").unbind("change");
		});	

	}

	function  check(){	
		var form = $("#myinfo_form");	
		if($.trim($("#user_email").val()) == '')	{
			//alert("Email不能为空！");
			$("#alert_content").html("Email不能为空！");
			$('#my-alert').modal({
				relatedTarget: this,
			});
			setTimeout(function(){
				$('#my-alert').modal('close');
			},1000);
			return false;
		}
		if($.trim($("#user_name").val()) == '')	{
			//alert("昵称不能为空！");
			$("#alert_content").html("昵称不能为空！");
			$('#my-alert').modal({
				relatedTarget: this,
			});
			setTimeout(function(){
				$('#my-alert').modal('close');
			},1000);
			return false;
		}
		var query = new Object();
		query.user_email = $("#user_email").val();	
		query.user_name = $("#user_name").val();
		query.sex = $("#sex option:selected").val();
		query.birth = $("#birth").val();
		query.my_intro = $("#my_intro").val();
		query.post_type = "json";
		//alert(query.user_email+"--"+query.user_name+"--"+query.sex+"--"+query.birth+"--"+query.post_type+"--"+query.my_intro);
		var ajaxurl = form.attr("action");
		$.ajax({
			url:ajaxurl,
			data:query,
			type:"post",
			dataType:"json",
			success:function(data){
				if(data.status==1){ 	
					//alert(data.info);
					$("#alert_content").html(data.info);
					$('#my-alert').modal({
						relatedTarget: this,
					});
					setTimeout(function(){
						$('#my-alert').modal('close');
						window.location.href='{wap_url a="index" r="myinfo#index"}';
					},1000);				
				}else{
					//alert(data.info);
					$("#alert_content").html(data.info);
					$('#my-alert').modal({
						relatedTarget: this,
					});
				}
			}
			,error:function(){
				//alert("服务器提交错误");
				$("#alert_content").html("服务器提交错误，请稍后重新操作");
				$('#my-alert').modal({
					relatedTarget: this,
				});
			}
		});	
			return false;
		}
	</script>					

</body>
</html>	
	