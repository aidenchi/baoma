{if $is_ajax eq 1}
{include file="./inc/merchantlist_key_item.html"}
<?php die();?>
{/if}
{include file="./inc/header.html"} 
<?php
		$this->_var['parse_pagecss'][] = $this->_var['TMPL_REAL']."/css/merchantlist_index.css";	
			
?>
<link rel="stylesheet" type="text/css" href='{function name="parse_css" v="$parse_pagecss"}' />

<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.4"></script>
<script type="text/javascript">
$(document).ready(function(){
	if($("#hide_xpoint").val()>0 || $("#hide_quan_id").val()>0){//如果定位坐标有值或位置有值
		//alert($("#hide_xpoint").val()+"yes--"+$("#hide_quan_id").val());
	}else{//如果定位坐标没有值，也没有选择位置，则执行定位获取坐标读取我附近
		//alert("no--"+$("#hide_quan_id").val());
		get_nearby_store();
	}
});

function get_nearby_store(){	
	//alert("get_nearby_store");	
	$("#loading").show();
	if($("#hide_xpoint").val()>0 && $("#hide_ypoint").val()>0){
		ajaxgetbyxypoint($("#hide_xpoint").val(),$("#hide_ypoint").val());	
	}else{
		var geolocation = new BMap.Geolocation(); 
		geolocation.getCurrentPosition(function (r) { 			
			if (this.getStatus() == BMAP_STATUS_SUCCESS ) { 
				//origin = r.point.lng + "," + r.point.lat; 			
				//alert("我所在位置的坐标："+origin); 
				var longitude=r.point.lng;
				var latitude=r.point.lat;			
			/*模拟
			if(1!=1){
				var longitude=114.41776;
				var latitude=30.483698;
			*/
				$("#hide_xpoint").val(longitude);
				$("#hide_ypoint").val(latitude);
				//window.location.href=$("#nearby_part_href").val()+"&xpoint="+longitude+"&ypoint="+latitude;//定位成功，读取我所在位置附近
				//$("#loading").hide();
				ajaxgetbyxypoint(longitude,latitude);	
			}else{
				alert("定位加载失败，请稍后重试");
				//window.location.href=$("#nearby_part_href").val()+"&quan_id=1";//定位失败，读取全部位置				
				var query = new Object();
				query.quan_id = 1;
				query.is_ajax=1;
				$.ajax({
					url:'{wap_url a="index" r="merchantlist"}',
					data:query,
					type:"Post",
					dataType:"text",
					success:function(data){
						//alert("no");
						$("#J_key_item").html(data);
					}
					,error:function(){
						//alert("服务器提交错误");
					}
				});	
			}
		});	
	}
}

function ajaxgetbyxypoint(longitude,latitude){
	var ajaxurl = '{wap_url a="index" r="merchantlist"}';
	var query = new Object();
	query.cate_id = $("#hide_cate_id").val();
	query.age_id = $("#hide_age_id").val();
	query.xpoint = longitude;
	query.ypoint = latitude;
	query.is_ajax=1;
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"Post",
		dataType:"text",
		success:function(data){
			//alert("yes");
			$("#J_key_item").html(data);
		}
		,error:function(){
			//alert("服务器提交错误");
		}
	});	
}

/*
//将坐标返回到服务端;
function userxypoint(latitude,longitude){	 	
	var query = new Object();
	query.latitude = latitude;
	query.longitude = longitude;
	query.post_type = "json";
	var ajaxurl = '{url a="index" r="userxypoint"}';
	$.ajax({
		url:ajaxurl,
		data:query,
		type:"post",
		dataType:"json",
		success:function(data){					
		}
		,error:function(){					
		}
	});		 		
}
*/
</script>	


<div class="wrap">
	<div class="search_box_tx">
    	<div class="search_text_tx"> 
			<a class="search_ico_tx"><i class="fa fa-search"></i></a>
			<input type="text" placeholder="请输入店铺名称" id="keyword">
		</div>
		<div class="search_button_tx">
			<input type="Button" value="搜索" onclick="search_submit()">
		</div>
    </div>
	<div class="blank8"></div>
	
	<div id="J_key_item">
		{include file="./inc/merchantlist_key_item.html"}	
	</div>

</div>
	

<script type="text/javascript">		
			function  search_submit(){			
				var keyword=$("#keyword").val();
				var ajaxurl = '{wap_url a="index" r="merchantlist"}';
				var query = new Object();
				query.keyword = keyword;
				query.is_ajax=1;
				$.ajax({
					url:ajaxurl,
					data:query,
					type:"Post",
					dataType:"text",
					success:function(data){
						//alert(data);
						$("#J_key_item").html(data);
					}
					,error:function(){
						//alert("服务器提交错误");
					}
				});	
			}
		
</script>

{include file="./inc/footer.html"} 